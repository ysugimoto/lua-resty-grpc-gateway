lua_code_cache off;

init_by_lua_block {
  -- Define global import paths
  PROTOC_IMPORT_PATHS = {
    "/usr/local/protoc/include"
  }
}

server {
  listen 80;
  server_name localhost;

  access_log /dev/stdout;
  error_log /dev/stderr;

  location /helloworld.Greeter/SayHello {
    rewrite_by_lua_block {
      local cors = require("grpc-gateway.cors")
      cors("http://localhost:8080")
    }

    grpc_set_header Content-Type application/grpc;
    grpc_pass backend:9000;
  }

  location /rest {

## 1. Transform request from REST to gRPC
    access_by_lua_block {
      local proto = require("grpc-gateway.proto")
      local grequest = require("grpc-gateway.request")
      local p, err = proto.new("/etc/proto/helloworld.proto")
      if err then
        ngx.log(ngx.ERR, ("proto load error: %s"):format(err))
        return
      end
      local req = grequest.new(p)
      err = req:transform("helloworld.Greeter", "SayHello")
      if err then
        ngx.log(ngx.ERR, ("transform request error: %s"):format(err))
        return
      end
    }

## 2. Transform response from gPRC to JSON
    body_filter_by_lua_block {
      local proto = require("grpc-gateway.proto")
      local gresponse = require("grpc-gateway.response")
      local p, err = proto.new("/etc/proto/helloworld.proto")
      if err then
        ngx.log(ngx.ERR, ("proto load error: %s"):format(err))
        return
      end
      local resp = gresponse.new(p)
      err = resp:transform("helloworld.Greeter", "SayHello")
      if err then
        ngx.log(ngx.ERR, ("transform response error: %s"):format(err))
        return
      end
    }

## 3. Swap response header to `Content-Type: application/json`
    header_filter_by_lua_block {
      ngx.header["Content-Type"] = "application/json"
    }

    grpc_set_header TE trailers;
    grpc_set_header Content-Type application/grpc;
    grpc_pass backend:50001;
  }
}

